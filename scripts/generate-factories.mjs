#!/usr/bin/env node

/**
 * Auto-generate factory index.ts files for CMS components
 *
 * This script scans component folders and generates the factory index files
 * (component/index.ts, page/index.ts, experience/index.ts) automatically.
 *
 * This eliminates the need to manually maintain three separate factory files
 * with identical patterns.
 *
 * Usage:
 *   node scripts/generate-factories.mjs
 */

import fs from 'fs';
import path from 'path';
import { fileURLToPath } from 'url';
import config from './config.mjs';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);
const projectRoot = path.resolve(__dirname, '..');

/**
 * Discover components in a specific directory
 */
function discoverComponentsInDir(type) {
  const baseDir = config.getAbsolutePath(config.PATHS.cms[type]);

  if (!fs.existsSync(baseDir)) {
    console.warn(`‚ö†Ô∏è  Directory not found: ${baseDir}`);
    return [];
  }

  const folders = fs.readdirSync(baseDir, { withFileTypes: true })
    .filter(dirent => dirent.isDirectory())
    .map(dirent => dirent.name);

  const components = [];

  for (const folderName of folders) {
    const indexFile = path.join(baseDir, folderName, config.NAMING.indexFile(folderName));

    if (fs.existsSync(indexFile)) {
      components.push({
        name: folderName,
        varName: `${folderName}Component`,
        importPath: `./${folderName}/${folderName}Index`
      });
    }
  }

  return components;
}

/**
 * Generate factory file content
 */
function generateFactoryContent(type, components) {
  const factoryName = type.charAt(0).toUpperCase() + type.slice(1) + 'Factory';

  // Generate imports
  const imports = components
    .map(c => `import ${c.varName} from "${c.importPath}";`)
    .join('\n');

  // Generate dictionary entries
  const entries = components
    .map(c => `  "${c.name}": ${c.varName},`)
    .join('\n');

  return `${config.TEMPLATES.autoGenWarning}

import { type ComponentTypeDictionary } from "@/lib/optimizely-cms";
${imports}

/**
 * ${factoryName} - Auto-generated component registry
 *
 * This file is automatically generated by scripts/generate-factories.mjs
 * Run 'yarn generate:factories' to regenerate.
 */
export const ${factoryName}: ComponentTypeDictionary = {
${entries}
};

// Export as default for convenience
export default ${factoryName};
`;
}

/**
 * Main function
 */
async function main() {
  try {
    console.log('üè≠ Generating factory files...\n');

    const types = ['component', 'page', 'experience'];
    let totalGenerated = 0;

    for (const type of types) {
      console.log(`üì¶ Processing ${type} factory...`);

      // Discover components
      const components = discoverComponentsInDir(type);
      console.log(`   Found ${components.length} ${type}(s)`);

      // Generate factory content
      const factoryContent = generateFactoryContent(type, components);
      const factoryPath = path.join(
        config.getAbsolutePath(config.PATHS.cms[type]),
        'index.ts'
      );

      // Write factory file
      fs.writeFileSync(factoryPath, factoryContent, 'utf8');
      console.log(`   ‚úÖ Generated: ${path.relative(projectRoot, factoryPath)}\n`);

      totalGenerated++;
    }

    console.log(`‚ú® Successfully generated ${totalGenerated} factory files!\n`);

  } catch (error) {
    console.error(`\n‚ùå Error generating factories: ${error.message}`);
    console.error(error.stack);
    process.exit(1);
  }
}

main();
